#!/bin/bash
# tf-git CLI - handles init command and passes through to terraform wrapper

set -e

# Function to generate tf-git.auto.tf
run_init() {
  local filename="tf-git.auto.tf"
  
  # Check if file already exists
  if [ -f "$filename" ]; then
    echo "âš ï¸  tf-git.auto.tf already exists â€” aborting to avoid overwrite"
    echo "   Delete the file first if you want to regenerate it"
    return 1
  fi
  
  # Detect provider by checking existing .tf files
  local provider="azurerm"
  if grep -r "provider \"aws\"" *.tf 2>/dev/null | grep -q .; then
    provider="aws"
  elif grep -r "provider \"google\"" *.tf 2>/dev/null | grep -q .; then
    provider="google"
  elif grep -r "provider \"azurerm\"" *.tf 2>/dev/null | grep -q .; then
    provider="azurerm"
  fi
  
  # Generate provider-specific content
  local provider_block=""
  case "$provider" in
    aws)
      provider_block='provider "aws" {
  default_tags {
    tags = {
      git_sha    = var.git_sha
      git_branch = var.git_branch
      git_repo   = var.git_repo
    }
  }
}'
      ;;
    google)
      provider_block='provider "google" {
  # Note: GCP uses labels instead of tags
  # You may need to add labels per resource or use a module
}'
      ;;
    azurerm)
      provider_block='provider "azurerm" {
  features {}

  default_tags {
    tags = {
      git_sha    = var.git_sha
      git_branch = var.git_branch
      git_repo   = var.git_repo
    }
  }
}'
      ;;
  esac
  
  # Write the file
  cat > "$filename" <<EOF
# ===============================================
# tf-git generated file
# ===============================================
# This file was generated by 'tf-git init'
# It auto-configures Git tagging in Terraform.
# Safe to delete! Do not modify the generated file.
# ===============================================

variable "git_sha" {
  type    = string
  default = "unknown"
}

variable "git_branch" {
  type    = string
  default = "unknown"
}

variable "git_repo" {
  type    = string
  default = "unknown"
}

$provider_block
EOF
  
  echo ""
  echo "âœ¨ Created tf-git.auto.tf"
  echo "âœ”  Git tagging configured automatically (detected provider: $provider)"
  echo "ðŸ” Safe to delete the file if you change your tagging strategy"
  echo "ðŸ“ Commit the file if you want permanent tagging"
  echo ""
}

# Handle init command
if [ "$1" = "init" ]; then
  run_init
  exit $?
fi

# For all other commands, pass through to terraform wrapper
exec terraform "$@"

